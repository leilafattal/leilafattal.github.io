<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Leila's Photography Gallery</title>
  <link rel="stylesheet" href="../styles.css">
</head>

<body>
  <h1 id="galleryTitle">Admin - Leila's Photography Gallery</h1>

  <!-- Back Button -->
  <div class="back-button" id="backButton" style="display: none;">‚Üê Back to Albums</div>

  <!-- Upload Section -->
  <div class="upload-section" style="display:none;" id="uploadSection">
    <input type="file" id="fileInput" />
    <button id="uploadButton">Upload to Album</button>
  </div>

  <!-- Image Gallery Section -->
  <div class="gallery" id="gallery"></div>

  <script type="module">
    import { fetchFolders, fetchAlbumImages, supabase, bucket } from '../gallery.js';

    const galleryDiv = document.getElementById('gallery');
    const backButton = document.getElementById('backButton');
    const titleElement = document.getElementById('galleryTitle');
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    let currentAlbum = '';

    async function openAlbum(albumName) {
      currentAlbum = albumName;

      // Fetch images for the album and render them
      const { data: images, error } = await supabase.storage
        .from(bucket)
        .list(albumName, { limit: 100 });

      if (error) {
        console.error(error);
        return;
      }

      const galleryDiv = document.getElementById('gallery');
      galleryDiv.innerHTML = '';  // Clear current gallery

      images.forEach(async (file) => {
        const publicURL = supabase.storage.from(bucket).getPublicUrl(`${albumName}/${file.name}`).data.publicUrl;

        // Create an image item with .album-cover styling
        const imageItem = document.createElement('div');
        imageItem.classList.add('album-cover');  // Reuse the album cover class for consistency

        const imgElement = document.createElement('img');
        imgElement.src = publicURL;

        // Add the delete button and likes section as a div inside the image container
        const infoElement = document.createElement('div');
        infoElement.innerHTML = `<button onclick="deleteImage('${albumName}/${file.name}')">üóëÔ∏è</button>`;

        imageItem.appendChild(imgElement);
        imageItem.appendChild(infoElement);

        // Add right-click and long-press delete functionality
        addDeleteFunctionality(imageItem, `${albumName}/${file.name}`);

        galleryDiv.appendChild(imageItem);
      });

      document.getElementById('galleryTitle').textContent = albumName;
      document.getElementById('backButton').style.display = 'block';
      document.getElementById('uploadSection').style.display = 'block';
    }

    // Back to the main gallery (albums) view
    document.getElementById('backButton').addEventListener('click', () => {
      document.getElementById('uploadSection').style.display = 'none';  // Hide the upload section when showing albums
      document.getElementById('backButton').style.display = 'none';     // Hide the back button when showing albums
      galleryDiv.innerHTML = '';  // Clear existing content
      backButton.style.display = 'none';  // Hide back button on main page
      fetchFolders(galleryDiv, titleElement, backButton, openAlbum);  // Call fetchFolders with the necessary parameters
    });

    uploadButton.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (file && currentAlbum) {
        const { error } = await supabase.storage.from(bucket).upload(`${currentAlbum}/${file.name}`, file);
        if (error) {
          console.error('Upload failed:', error);
          return;
        }

        // Insert into the images table
        const { error: insertError } = await supabase
          .from('images')
          .insert({
            image_name: file.name,
            album_name: currentAlbum,
            storage_path: `${currentAlbum}/${file.name}`,
            likes: 0,
          });

        if (insertError) {
          console.error('Error inserting into images table:', insertError);
        } else {
          openAlbum(currentAlbum);  // Refresh the album
        }
      }
    });

    // Function to delete an image from the album
    async function deleteImage(fileName) {
      const { error } = await supabase.storage.from(bucket).remove([fileName]);

      if (error) {
        console.error('Error deleting image:', error);
        alert('Error deleting image!');
      } else {
        // Remove from the "images" table in Supabase
        const { error: deleteError } = await supabase
          .from('images')
          .delete()
          .eq('storage_path', fileName);

        if (deleteError) {
          console.error('Error deleting image metadata:', deleteError);
        } else {
          //alert('Image deleted successfully!');
          openAlbum(currentAlbum);  // Refresh the album after deletion
        }
      }
    }

    // Add right-click event and long press event for deleting images
    function addDeleteFunctionality(imageItem, fileName) {
      // Right-click event for deleting images on desktop
      imageItem.addEventListener('contextmenu', (event) => {
        event.preventDefault();  // Prevent the default context menu from appearing
        const confirmDelete = confirm('Are you sure you want to delete this image?');
        if (confirmDelete) {
          deleteImage(fileName);
        }
      });

      // Long-press event for mobile to delete an image
      let touchTimer;
      imageItem.addEventListener('touchstart', () => {
        touchTimer = setTimeout(() => {
          const confirmDelete = confirm('Are you sure you want to delete this image?');
          if (confirmDelete) {
            deleteImage(fileName);
          }
        }, 1000);  // Trigger delete after 1 second of holding
      });

      imageItem.addEventListener('touchend', () => {
        clearTimeout(touchTimer);  // Cancel if the touch is released before 1 second
      });
    }


    window.onload = () => fetchFolders(galleryDiv, titleElement, backButton, openAlbum);
    window.deleteImage = deleteImage;  // Expose deleteImage globally
  </script>
</body>

</html>